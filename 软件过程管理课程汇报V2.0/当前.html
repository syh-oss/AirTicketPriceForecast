import requests
import json
import time
import random
from datetime import datetime, timedelta
from bs4 import BeautifulSoup
import pandas as pd
from urllib.parse import urlencode

class FlightSpider:
    def __init__(self):
        self.session = requests.Session()
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        }
        self.flight_data = []
    
    def search_flights(self, departure, arrival, date):
        """搜索航班信息"""
        # 模拟携程API请求
        params = {
            'departure': departure,
            'arrival': arrival,
            'date': date
        }
        
        try:
            # 这里使用模拟数据，实际应用中需要替换为真实的API调用
            flights = self._mock_api_call(departure, arrival, date)
            self.flight_data.extend(flights)
            return flights
            
        except Exception as e:
            print(f"搜索航班失败: {e}")
            return []
    
    def _mock_api_call(self, departure, arrival, date):
        """模拟API调用返回航班数据"""
        airlines = ['中国国航', '东方航空', '南方航空', '海南航空', '厦门航空']
        flight_numbers = ['CA1234', 'MU5678', 'CZ9012', 'HU3456', 'MF7890']
        
        flights = []
        for i in range(5):
            base_price = random.randint(300, 2000)
            flight = {
                'airline': random.choice(airlines),
                'flight_number': random.choice(flight_numbers),
                'departure_city': departure,
                'arrival_city': arrival,
                'departure_time': f"{random.randint(6, 22)}:{random.randint(0, 59):02d}",
                'arrival_time': f"{random.randint(8, 23)}:{random.randint(0, 59):02d}",
                'price': base_price,
                'discount_price': base_price - random.randint(0, 200),
                'aircraft': f'Boeing 73{random.randint(7, 9)}',
                'duration': f'{random.randint(1, 5)}h{random.randint(0, 59)}m',
                'date': date,
                'timestamp': datetime.now().isoformat()
            }
            flights.append(flight)
        
        return flights
    
    def save_to_csv(self, filename='flights_data.csv'):
        """保存数据到CSV文件"""
        if self.flight_data:
            df = pd.DataFrame(self.flight_data)
            df.to_csv(filename, index=False, encoding='utf-8-sig')
            print(f"数据已保存到 {filename}")
    
    def get_price_trend(self, departure, arrival, days=7):
        """获取价格趋势数据"""
        price_trend = []
        base_date = datetime.now()
        
        for i in range(days):
            date_str = (base_date + timedelta(days=i)).strftime('%Y-%m-%d')
            flights = self._mock_api_call(departure, arrival, date_str)
            if flights:
                min_price = min(flight['price'] for flight in flights)
                price_trend.append({
                    'date': date_str,
                    'min_price': min_price,
                    'avg_price': sum(flight['price'] for flight in flights) / len(flights)
                })
        
        return price_trend

if __name__ == "__main__":
    spider = FlightSpider()
    
    # 示例搜索
    flights = spider.search_flights('北京', '上海', '2024-01-15')
    print(f"找到 {len(flights)} 个航班")
    
    # 保存数据
    spider.save_to_csv()
<code_end>

<code_start project_name=机票爬虫系统 filename=data_processor.py title=数据处理与分析模块 entrypoint=false runnable=false project_final_file=false>
import pandas as pd
import numpy as np
from datetime import datetime
import json

class FlightDataProcessor:
    def __init__(self, data_source='flights_data.csv'):
        self.data_source = data_source
        self.df = None
    
    def load_data(self):
        """加载航班数据"""
        try:
            self.df = pd.read_csv(self.data_source)
            print(f"成功加载 {len(self.df)} 条航班数据")
        except FileNotFoundError:
            print("数据文件不存在")
            self.df = pd.DataFrame()
    
    def clean_data(self):
        """数据清洗"""
        if self.df is not None and not self.df.empty:
            # 去除重复数据
            self.df = self.df.drop_duplicates()
            
            # 处理缺失值
            self.df = self.df.fillna({
                'price': self.df['price'].median(),
                'discount_price': self.df['discount_price'].median()
            })
            
            # 数据类型转换
            self.df['timestamp'] = pd.to_datetime(self.df['timestamp'])
            self.df['date'] = pd.to_datetime(self.df['date'])
    
    def analyze_prices(self):
        """价格分析"""
        if self.df is None or self.df.empty:
            return {}
        
        analysis = {
            'total_flights': len(self.df),
            'average_price': self.df['price'].mean(),
            'min_price': self.df['price'].min(),
            'max_price': self.df['price'].max(),
            'price_std': self.df['price'].std(),
            'cheapest_airline': self.df.loc[self.df['price'].idxmin(), 'airline'],
            'most_expensive_airline': self.df.loc[self.df['price'].idxmax(), 'airline']
        }
        
        return analysis
    
    def get_airline_stats(self):
        """航空公司统计"""
        if self.df is None or self.df.empty:
            return {}
        
        airline_stats = self.df.groupby('airline').agg({
            'price': ['count', 'mean', 'min', 'max'],
            'discount_price': 'mean'
        }).round(2)
        
        return airline_stats
    
    def filter_flights(self, criteria):
        """根据条件筛选航班"""
        filtered_df = self.df.copy()
        
        if 'max_price' in criteria:
            filtered_df = filtered_df[filtered_df['price'] <= criteria['max_price']]
        
        if 'airlines' in criteria:
            filtered_df = filtered_df[filtered_df['airline'].isin(criteria['airlines'])]
        
        if 'time_range' in criteria:
            # 简化处理，实际需要更复杂的时间解析
            pass
        
        return filtered_df
    
    def export_analysis_report(self, filename='flight_analysis_report.json'):
        """导出分析报告"""
        analysis = self.analyze_prices()
        airline_stats = self.get_airline_stats()
        
        report = {
            'analysis_date': datetime.now().isoformat(),
            'summary': analysis,
            'airline_statistics': airline_stats.to_dict()
        }
        
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(report, f, ensure_ascii=False, indent=2)
        
        print(f"分析报告已导出到 {filename}")
        return report
<code_end>

<code_start project_name=机票爬虫系统 filename=flight_visualizer.html title=航班数据可视化界面 entrypoint=false runnable=false project_final_file=false>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机票数据分析平台</title>
    <script src="https://cdn.tailwindcss.com"></script>


该机票爬虫系统包含三个核心模块：数据抓取模块负责从机票平台获取航班信息，数据处理模块进行数据清洗和分析，可视化界面提供直观的数据展示。系统支持航班搜索、价格趋势分析和多维度数据统计功能，采用模块化设计便于扩展和维护。